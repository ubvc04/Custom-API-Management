{% extends "base.html" %}

{% block title %}API Keys - API Manager{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">API Keys</h1>
                <p class="text-gray-600 mt-2">Manage your API keys and monitor their usage</p>
            </div>
            <button onclick="openGenerateModal()" class="btn-hover gradient-bg text-white px-6 py-3 rounded-lg shadow-lg">
                <i class="fas fa-plus mr-2"></i>
                Generate New Key
            </button>
        </div>
    </div>

    <!-- API Keys Table -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold text-gray-900">Your API Keys</h2>
                <div class="flex items-center space-x-4">
                    <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="revoked">Revoked</option>
                    </select>
                    <button onclick="refreshKeys()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-refresh"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Name
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Key Preview
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Usage
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Created
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Expires
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody id="keysTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Keys will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div id="emptyState" class="hidden text-center py-12">
            <i class="fas fa-key text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No API keys found</h3>
            <p class="text-gray-600 mb-4">Get started by generating your first API key</p>
            <button onclick="openGenerateModal()" class="gradient-bg text-white px-6 py-3 rounded-lg">
                <i class="fas fa-plus mr-2"></i>
                Generate First Key
            </button>
        </div>
    </div>
</div>

<!-- Generate Key Modal -->
<div id="generateModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Generate New API Key</h3>
                <button onclick="closeGenerateModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="generateForm" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div>
                    <label for="keyName" class="block text-sm font-medium text-gray-700">
                        Key Name (optional)
                    </label>
                    <input type="text" id="keyName" name="name" 
                           class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                           placeholder="e.g., Production API Key">
                </div>
                
                <div>
                    <label for="expiryDays" class="block text-sm font-medium text-gray-700">
                        Expires in (days, optional)
                    </label>
                    <input type="number" id="expiryDays" name="expires_in_days" min="1" max="365"
                           class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                           placeholder="Leave empty for no expiration">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeGenerateModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90">
                        <i class="fas fa-key mr-2"></i>
                        Generate Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Show Key Modal -->
<div id="showKeyModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-key text-green-600 mr-2"></i>
                    API Key Generated Successfully
                </h3>
                <button onclick="closeShowKeyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                <div class="flex">
                    <i class="fas fa-exclamation-triangle text-yellow-400 mr-2 mt-1"></i>
                    <div>
                        <p class="text-sm text-yellow-800">
                            <strong>Important:</strong> Please copy this API key now. You won't be able to see it again!
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Your API Key:</label>
                <div class="flex">
                    <input type="text" id="generatedKey" readonly
                           class="flex-1 border border-gray-300 rounded-l-md px-3 py-2 bg-gray-50 font-mono text-sm">
                    <button onclick="copyKey()" class="px-4 py-2 bg-gray-200 border border-l-0 border-gray-300 rounded-r-md hover:bg-gray-300">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                <h4 class="font-medium text-blue-900 mb-2">How to use this API key:</h4>
                <code class="text-sm text-blue-800 bg-blue-100 px-2 py-1 rounded">
                    curl -H "X-API-Key: YOUR_API_KEY" {{ request.url_root }}api/test
                </code>
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeShowKeyModal()" 
                        class="px-4 py-2 gradient-success text-white rounded-md">
                    <i class="fas fa-check mr-2"></i>
                    I've Saved My Key
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Key Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Edit API Key</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editForm" class="space-y-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="editKeyId" name="key_id">
                
                <div>
                    <label for="editKeyName" class="block text-sm font-medium text-gray-700">
                        Key Name
                    </label>
                    <input type="text" id="editKeyName" name="name" 
                           class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-purple-500 focus:border-purple-500">
                </div>
                
                <div>
                    <label for="editExpiryDays" class="block text-sm font-medium text-gray-700">
                        Expires in (days, optional)
                    </label>
                    <input type="number" id="editExpiryDays" name="expires_in_days" min="1" max="365"
                           class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                           placeholder="Leave empty for no expiration">
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90">
                        <i class="fas fa-save mr-2"></i>
                        Update Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- OTP Verification Modal -->
<div id="otpModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">🔐 Security Verification</h3>
                <p class="text-sm text-gray-600 mt-1">Enter the OTP sent to your email</p>
            </div>
            
            <form id="otpForm">
                <div class="px-6 py-4 space-y-4">
                    <div id="otpActionInfo" class="bg-blue-50 border border-blue-200 rounded-md p-3">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span id="otpActionText">An OTP has been sent to your email.</span>
                        </p>
                    </div>
                    
                    <div>
                        <label for="otpCode" class="block text-sm font-medium text-gray-700 mb-2">
                            6-Digit OTP Code
                        </label>
                        <input type="text" 
                               id="otpCode" 
                               name="otp_code" 
                               maxlength="6" 
                               pattern="[0-9]{6}"
                               placeholder="123456"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md text-center text-2xl tracking-widest"
                               required>
                        <p class="text-xs text-gray-500 mt-1">Code expires in 10 minutes</p>
                    </div>
                    
                    <div id="otpError" class="hidden text-red-600 text-sm"></div>
                </div>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button type="button" onclick="closeOtpModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" onclick="requestNewOtp()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Resend OTP
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 gradient-bg text-white rounded-md hover:opacity-90">
                        <i class="fas fa-check mr-2"></i>
                        Verify & Continue
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let apiKeys = [];
    let pendingOtpAction = null; // Store the pending action (create/delete) and its data

    // Load API keys
    async function loadKeys() {
        try {
            const response = await fetch('/keys/list');
            const data = await response.json();
            apiKeys = data.keys;
            renderKeys();
        } catch (error) {
            console.error('Error loading keys:', error);
            showFlashMessage('Failed to load API keys', 'error');
        }
    }

    function renderKeys() {
        const tbody = document.getElementById('keysTableBody');
        const emptyState = document.getElementById('emptyState');
        const statusFilter = document.getElementById('statusFilter').value;
        
        let filteredKeys = apiKeys;
        if (statusFilter) {
            filteredKeys = apiKeys.filter(key => key.status === statusFilter);
        }
        
        if (filteredKeys.length === 0) {
            tbody.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        tbody.innerHTML = filteredKeys.map(key => {
            const statusColor = {
                'active': 'bg-green-100 text-green-800',
                'inactive': 'bg-yellow-100 text-yellow-800',
                'revoked': 'bg-red-100 text-red-800'
            }[key.status];
            
            const expiresText = key.expires_at ? 
                new Date(key.expires_at).toLocaleDateString() : 
                'Never';
            
            const createdText = new Date(key.created_at).toLocaleDateString();
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${key.name || 'Unnamed Key'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <code class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">${key.key_preview}</code>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                            ${key.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${key.usage_count.toLocaleString()} requests
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${createdText}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${expiresText}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            ${key.status !== 'revoked' ? `
                                <button onclick="editKey(${key.id})" class="text-blue-600 hover:text-blue-900" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleKeyStatus(${key.id}, '${key.status === 'active' ? 'inactive' : 'active'}')" 
                                        class="text-yellow-600 hover:text-yellow-900" title="${key.status === 'active' ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-${key.status === 'active' ? 'pause' : 'play'}"></i>
                                </button>
                                <button onclick="regenerateKey(${key.id})" class="text-green-600 hover:text-green-900" title="Regenerate">
                                    <i class="fas fa-sync"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteKey(${key.id})" class="text-red-600 hover:text-red-900" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="viewUsage(${key.id})" class="text-purple-600 hover:text-purple-900" title="View Usage">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // OTP Modal functions
    function openOtpModal(actionType, actionData = null) {
        pendingOtpAction = { type: actionType, data: actionData };
        
        const actionText = actionType === 'create' ? 'Create API Key' : 'Delete API Key';
        document.getElementById('otpActionText').textContent = `OTP required to ${actionText.toLowerCase()}. Check your email.`;
        
        document.getElementById('otpModal').classList.remove('hidden');
        document.getElementById('otpCode').focus();
    }

    function closeOtpModal() {
        document.getElementById('otpModal').classList.add('hidden');
        document.getElementById('otpForm').reset();
        document.getElementById('otpError').classList.add('hidden');
        pendingOtpAction = null;
    }

    async function requestNewOtp() {
        if (!pendingOtpAction) return;
        
        try {
            const response = await fetch('/keys/request-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action_type: pendingOtpAction.type
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showFlashMessage(data.message, 'success');
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showFlashMessage(error.message, 'error');
        }
    }

    // Modal functions
    function openGenerateModal() {
        document.getElementById('generateModal').classList.remove('hidden');
    }

    function closeGenerateModal() {
        document.getElementById('generateModal').classList.add('hidden');
        document.getElementById('generateForm').reset();
    }

    function closeShowKeyModal() {
        document.getElementById('showKeyModal').classList.add('hidden');
    }

    function openEditModal(key) {
        document.getElementById('editKeyId').value = key.id;
        document.getElementById('editKeyName').value = key.name || '';
        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editForm').reset();
    }

    // Key actions
    async function editKey(keyId) {
        const key = apiKeys.find(k => k.id === keyId);
        if (key) {
            openEditModal(key);
        }
    }

    async function toggleKeyStatus(keyId, newStatus) {
        try {
            const result = await apiRequest(`/keys/${keyId}/status`, {
                method: 'POST',
                body: JSON.stringify({ status: newStatus })
            });
            
            showFlashMessage(result.message, 'success');
            loadKeys();
        } catch (error) {
            // Error already shown
        }
    }

    async function regenerateKey(keyId) {
        if (!confirm('Are you sure you want to regenerate this API key? The old key will stop working immediately.')) {
            return;
        }
        
        try {
            const result = await apiRequest(`/keys/${keyId}/regenerate`, {
                method: 'POST'
            });
            
            document.getElementById('generatedKey').value = result.api_key;
            document.getElementById('showKeyModal').classList.remove('hidden');
            loadKeys();
        } catch (error) {
            // Error already shown
        }
    }

    async function deleteKey(keyId) {
        if (!confirm('Are you sure you want to delete this API key? This action cannot be undone.')) {
            return;
        }
        
        // Request OTP first
        try {
            const response = await fetch('/keys/request-otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action_type: 'delete'
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                openOtpModal('delete', { keyId: keyId });
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            showFlashMessage(error.message, 'error');
        }
    }

    function viewUsage(keyId) {
        window.location.href = `/dashboard/usage?key_id=${keyId}`;
    }

    function copyKey() {
        const keyInput = document.getElementById('generatedKey');
        keyInput.select();
        document.execCommand('copy');
        showFlashMessage('API key copied to clipboard!', 'success');
    }

    function refreshKeys() {
        loadKeys();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        loadKeys();
        
        // Status filter
        document.getElementById('statusFilter').addEventListener('change', renderKeys);
        
        // Generate form
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // Request OTP first
            try {
                const response = await fetch('/keys/request-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action_type: 'create'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    closeGenerateModal();
                    openOtpModal('create', data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showFlashMessage(error.message, 'error');
            }
        });
        
        // Edit form
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            const keyId = data.key_id;
            
            try {
                const result = await apiRequest(`/keys/${keyId}/update`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                closeEditModal();
                showFlashMessage(result.message, 'success');
                loadKeys();
            } catch (error) {
                // Error already shown
            }
        });
        
        // OTP form
        document.getElementById('otpForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!pendingOtpAction) {
                showFlashMessage('No pending action to verify', 'error');
                return;
            }
            
            const formData = new FormData(this);
            const otpCode = formData.get('otp_code');
            
            try {
                if (pendingOtpAction.type === 'create') {
                    // Include OTP in the create request
                    const createData = { ...pendingOtpAction.data, otp_code: otpCode };
                    
                    const result = await fetch('/keys/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(createData)
                    });
                    
                    const data = await result.json();
                    
                    if (result.ok) {
                        closeOtpModal();
                        document.getElementById('generatedKey').value = data.api_key;
                        document.getElementById('showKeyModal').classList.remove('hidden');
                        loadKeys();
                        showFlashMessage(data.message, 'success');
                    } else {
                        throw new Error(data.error);
                    }
                    
                } else if (pendingOtpAction.type === 'delete') {
                    // Include OTP in the delete request
                    const deleteData = { otp_code: otpCode };
                    const keyId = pendingOtpAction.data.keyId;
                    
                    const result = await fetch(`/keys/${keyId}/delete`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(deleteData)
                    });
                    
                    const data = await result.json();
                    
                    if (result.ok) {
                        closeOtpModal();
                        loadKeys();
                        showFlashMessage(data.message, 'success');
                    } else {
                        throw new Error(data.error);
                    }
                }
                
            } catch (error) {
                const errorDiv = document.getElementById('otpError');
                errorDiv.textContent = error.message;
                errorDiv.classList.remove('hidden');
                
                // Clear error after 5 seconds
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }
        });
    });
</script>
{% endblock %}